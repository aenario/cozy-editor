var __bind=function(e,t){return function(){return e.apply(t,arguments)}};CNeditor=function(){function e(e,t){this._processPaste=__bind(this._processPaste,this),this._keyPressListener=__bind(this._keyPressListener,this);var n,r,i,s=this;e.nodeName==="IFRAME"?(console.log("et hop !"),this.getEditorSelection=function(){return rangy.getIframeSelection(e)},this.saveEditorSelection=function(){return rangy.saveSelection(rangy.dom.getIframeWindow(e))},r=$(e),r.on("load",function(){var n,i,o;return o=r.contents().find("html"),n=o.find("body"),n.parent().attr("id","__ed-iframe-html"),n.attr("contenteditable","true"),n.attr("id","__ed-iframe-body"),s.document=n[0].ownerDocument,i=o.find("head"),i.html('<link id="editorCSS" href="stylesheets/CNeditor.css" rel="stylesheet">'),s.editorBody$=n,s.editorTarget=e,s._lines={},s.newPosition=!0,s._highestId=0,s._deepest=1,s._firstLine=null,s._history={index:0,history:[null],historySelect:[null],historyScroll:[null],historyPos:[null]},s._lastKey=null,n.prop("__editorCtl",s),n.on("mouseup",function(){return s.newPosition=!0}),n.on("keydown",s._keyPressListener),n.on("keyup",function(){return r.trigger(jQuery.Event("onKeyUp"))}),n.on("click",function(e){return s._lastKey=null}),n.on("paste",function(e){return console.log("pasting..."),s.paste(e)}),s._initClipBoard(),t.call(s),s}),e.src=""):(console.log("target is not an iframe..."),this.getEditorSelection=function(){return rangy.getSelection()},this.saveEditorSelection=function(){return rangy.saveSelection()},i=$(e),n=function(){var n;return n=i,n.attr("contenteditable","true"),n.attr("id","__ed-iframe-body"),s.editorBody$=n,s.editorTarget=e,s._lines={},s.newPosition=!0,s._highestId=0,s._deepest=1,s._firstLine=null,s._history={index:0,history:[null],historySelect:[null],historyScroll:[null],historyPos:[null]},s._lastKey=null,n.prop("__editorCtl",s),n.on("keydown",s._keyPressListener),n.on("mouseup",function(){return s.newPosition=!0}),n.on("keyup",function(){return i.trigger(jQuery.Event("onKeyUp"))}),n.on("click",function(e){return s._lastKey=null}),n.on("paste",function(e){return console.log("pasting..."),s.paste(e)}),t.call(s),s},n(),this._initClipBoard())}return e.prototype._updateDeepest=function(){var e,t,n;n=1,t=this._lines;for(e in t)this.editorBody$.children("#"+(""+t[e].lineID)).length>0&&t[e].lineType==="Th"&&t[e].lineDepthAbs>n&&(n=this._lines[e].lineDepthAbs);if(n!==this._deepest)return this._deepest=n,n<4?this.replaceCSS("stylesheets/app-deep-"+n+".css"):this.replaceCSS("stylesheets/app-deep-4.css")},e.prototype.replaceContent=function(e){return this.editorBody$.html(e),this._readHtml(),this._initClipBoard()},e.prototype.deleteContent=function(){return this.editorBody$.html('<div id="CNID_1" class="Tu-1"><span></span><br></div>'),this._readHtml(),this._initClipBoard()},e.prototype.getEditorContent=function(){var e;return e=this.editorBody$.html(),this._cozy2md(e)},e.prototype.setEditorContent=function(e){var t;return t=this._md2cozy(e),this.editorBody$.html(t),this._readHtml(),this._initClipBoard()},e.prototype.replaceCSS=function(e){var t,n;return t=this.document,n=t.querySelector("#editorCSS"),n.setAttribute("href",e),t.head.appendChild(n)},e.prototype._putEndOnEnd=function(e,t){var n,r;return t.lastChild!=null?(r=t.lastChild.textContent.length,r===0&&(t.lastChild.data=" ",r=1),e.setEnd(t.lastChild,r)):(n=document.createTextNode(" "),t.appendChild(n),e.setEnd(n,1))},e.prototype._putStartOnEnd=function(e,t){var n,r;return t.lastChild!=null?(r=t.lastChild.textContent.length,r===0&&(t.lastChild.data=" ",r=1),e.setStart(t.lastChild,r)):(n=document.createTextNode(" "),t.appendChild(n),e.setStart(n,0))},e.prototype._putEndOnStart=function(e,t){var n,r;return t.firstChild!=null?(r=t.firstChild.textContent.length,r===0&&(t.firstChild.data=" "),e.setEnd(t.firstChild,0)):(n=document.createTextNode(" "),t.appendChild(n),e.setEnd(n,0))},e.prototype._putStartOnStart=function(e,t){var n,r;return t.firstChild!=null?(r=t.firstChild.textContent.length,r===0&&(t.firstChild.data=" "),e.setStart(t.firstChild,0)):(n=document.createTextNode(" "),t.appendChild(n),e.setStart(n,0))},e.prototype._normalize=function(e){var t,n,r,i,s,o,u,a,f;e.startContainer.nodeName==="BODY"?o=e.startContainer.children[e.startOffset]:o=e.startContainer,e.endContainer.nodeName==="BODY"?r=e.endContainer.children[e.endOffset-1]:r=e.endContainer,o.nodeName!=="DIV"&&(o=$(o).parents("div")[0]),r.nodeName!=="DIV"&&(r=$(r).parents("div")[0]),o===r&&o.innerHTML==="<span></span><br>"&&(this.isEmptyLine=!0),s=e.startContainer;if(s.nodeName==="BODY")t=s.children[e.startOffset].firstChild,this._putStartOnStart(e,t);else if(s.nodeName==="DIV")this.isEmptyLine?(t=s.childNodes[0],this._putStartOnStart(e,t)):e.startOffset<s.childNodes.length-1?(t=s.childNodes[e.startOffset],this._putStartOnStart(e,t)):(t=s.lastChild.previousElementSibling,this._putStartOnEnd(e,t));else if((a=s.nodeName)==="SPAN"||a==="IMG"||a==="A")s.firstChild===null||s.textContent.length===0?this._putStartOnEnd(e,s):e.startOffset<s.childNodes.length?(u=s.childNodes[e.startOffset],e.setStart(u,0)):(u=s.lastChild,i=u.data.length,e.setStart(u,i));n=e.endContainer,n.nodeName==="BODY"&&(t=n.children[e.endOffset-1].lastChild,this._putEndOnEnd(e,t.previousElementSibling));if(n.nodeName==="DIV")e.endOffset<n.childNodes.length-1?(t=n.childNodes[e.endOffset],this._putEndOnStart(e,t)):(t=n.lastChild.previousElementSibling,this._putEndOnEnd(e,t));else if((f=n.nodeName)==="SPAN"||f==="IMG"||f==="A")(n.firstChild===null||n.textContent.length===0)&&this._putEndOnEnd(e,n),e.endOffset<n.childNodes.length?(u=s.childNodes[e.endOffset],e.setEnd(u,0)):(u=n.lastChild,i=u.data.length,e.setEnd(u,i));return e},e.prototype._keyPressListener=function(e){var t,n,r,i,s,o,u;n=(e.altKey?"Alt":"")+(e.ctrlKey?"Ctrl":"")+(e.shiftKey?"Shift":"");switch(e.keyCode){case 13:t="return";break;case 35:t="end";break;case 36:t="home";break;case 33:t="pgUp";break;case 34:t="pgDwn";break;case 37:t="left";break;case 38:t="up";break;case 39:t="right";break;case 40:t="down";break;case 9:t="tab";break;case 8:t="backspace";break;case 32:t="space";break;case 27:t="esc";break;case 46:t="suppr";break;case 16:e.preventDefault();return;case 17:e.preventDefault();return;case 18:e.preventDefault();return;default:switch(e.which){case 32:t="space";break;case 8:t="backspace";break;case 65:t="A";break;case 83:t="S";break;case 86:t="V";break;case 89:t="Y";break;case 90:t="Z";break;default:t="other"}}u=n+"-"+t;if(u==="-A"||u==="-S"||u==="-V"||u==="-Y"||u==="-Z")u="-other";this._lastKey!==u&&(u==="-tab"||u==="-return"||u==="-backspace"||u==="-suppr"||u==="CtrlShift-down"||u==="CtrlShift-up"||u==="CtrlShift-left"||u==="CtrlShift-right"||u==="Ctrl-V"||u==="Shift-tab"||u==="-space"||u==="-other")&&this._addHistory(),this._lastKey=u,this.newPosition&&(u==="-other"||u==="-space"||u==="-suppr"||u==="-backspace"||u==="-return")&&(this.newPosition=!1,o=this.getEditorSelection(),s=o.getRangeAt(0),r=rangy.createRange(),r=this._normalize(s),i=this.getEditorSelection(),i.setSingleRange(r)),(t==="left"||t==="up"||t==="right"||t==="down"||t==="pgUp"||t==="pgDwn"||t==="end"||t==="home"||t==="return"||t==="suppr"||t==="backspace")&&u!=="CtrlShift-down"&&u!=="CtrlShift-up"&&u!=="CtrlShift-right"&&u!=="CtrlShift-left"&&(this.newPosition=!0),this.currentSel=null;switch(u){case"-return":return this._return(),e.preventDefault();case"-tab":return this.tab(),e.preventDefault();case"CtrlShift-right":return this.tab(),e.preventDefault();case"-backspace":return this._backspace(e);case"-suppr":return this._suppr(e);case"CtrlShift-down":return this._moveLinesDown(),e.preventDefault();case"CtrlShift-up":return this._moveLinesUp(),e.preventDefault();case"Shift-tab":return this.shiftTab(),e.preventDefault();case"CtrlShift-left":return this.shiftTab(),e.preventDefault();case"Alt-A":return this._toggleLineType(),e.preventDefault();case"Ctrl-V":return!0;case"Ctrl-S":return $(this.editorTarget).trigger(jQuery.Event("saveRequest")),e.preventDefault();case"Ctrl-Z":return e.preventDefault(),this.unDo();case"Ctrl-Y":return e.preventDefault(),this.reDo()}},e.prototype._suppr=function(e){var t,n;this._findLinesAndIsStartIsEnd(),t=this.currentSel,this.isEmptyLine&&(this.isEmptyLine=!1,t.range.deleteContents()),n=t.startLine;if(!t.range.collapsed)return t.endLine===n?(t.range.deleteContents(),e.preventDefault()):(this._deleteMultiLinesSelections(),e.preventDefault());if(t.rangeIsEndLine)return n.lineNext!==null?(t.range.setEndBefore(n.lineNext.line$[0].firstChild),t.endLine=n.lineNext,this._deleteMultiLinesSelections(),e.preventDefault()):e.preventDefault()},e.prototype._backspace=function(e){var t,n;this._findLinesAndIsStartIsEnd(),t=this.currentSel,this.isEmptyLine&&(this.isEmptyLine=!1,t.range.deleteContents()),n=t.startLine;if(!t.range.collapsed)return t.endLine===n?(t.range.deleteContents(),e.preventDefault()):(this._deleteMultiLinesSelections(),e.preventDefault());if(t.rangeIsStartLine)return n.linePrev!==null?(t.range.setStartBefore(n.linePrev.line$[0].lastChild),t.startLine=n.linePrev,this._deleteMultiLinesSelections(),e.preventDefault()):e.preventDefault()},e.prototype.titleList=function(){var e,t,n,r,i,s,o,u;s=this.getEditorSelection(),i=s.getRangeAt(0),i.startContainer.nodeName==="BODY"?o=i.startContainer.children[i.startOffset]:o=i.startContainer,i.endContainer.nodeName==="BODY"?e=i.endContainer.children[i.endOffset-1]:e=i.endContainer,o.nodeName!=="DIV"&&(o=$(o).parents("div")[0]),e.nodeName!=="DIV"&&(e=$(e).parents("div")[0]),n=e.id,r=this._lines[o.id],t=e.id,u=[];for(;;){this._line2titleList(r);if(r.lineID===t)break;u.push(r=r.lineNext)}return u},e.prototype._line2titleList=function(e){var t,n;if(e.lineType!=="Th"){e.lineType[0]==="L"&&(e.lineType="Tu",e.lineDepthAbs+=1),this._titilizeSiblings(e),t=this._findParent1stSibling(e),n=[];while(t!==null&&t.lineType!=="Th")this._titilizeSiblings(t),n.push(t=this._findParent1stSibling(t));return n}},e.prototype._titilizeSiblings=function(e){var t,n;n=e.lineDepthAbs,t=e;while(t!==null&&t.lineDepthAbs>=n){if(t.lineDepthAbs===n)switch(t.lineType){case"Tu":case"To":t.line$.prop("class","Th-"+n),t.lineType="Th",t.lineDepthRel=0;break;case"Lu":case"Lo":t.line$.prop("class","Lh-"+n),t.lineType="Lh",t.lineDepthRel=0}t=t.lineNext}t=e.linePrev;while(t!==null&&t.lineDepthAbs>=n){if(t.lineDepthAbs===n)switch(t.lineType){case"Tu":case"To":t.line$.prop("class","Th-"+n),t.lineType="Th",t.lineDepthRel=0;break;case"Lu":case"Lo":t.line$.prop("class","Lh-"+n),t.lineType="Lh",t.lineDepthRel=0}t=t.linePrev}return!0},e.prototype.markerList=function(e){var t,n,r,i,s,o,u,a;e!=null?(u=e.lineID,n=u):(s=this.getEditorSelection().getRangeAt(0),s.startContainer.nodeName==="BODY"?o=s.startContainer.children[s.startOffset]:o=s.startContainer,s.endContainer.nodeName==="BODY"?t=s.endContainer.children[s.endOffset-1]:t=s.endContainer,o.nodeName!=="DIV"&&(o=$(o).parents("div")[0]),u=o.id,t.nodeName!=="DIV"&&(t=$(t).parents("div")[0]),n=t.id),r=this._lines[u],a=[];for(;;){switch(r.lineType){case"Th":i="Tu",e=r.lineNext;while(e!==null&&e.lineDepthAbs>=r.lineDepthAbs){switch(e.lineType){case"Th":e.line$.prop("class","Tu-"+e.lineDepthAbs),e.lineType="Tu",e.lineDepthRel=this._findDepthRel(e);break;case"Lh":e.line$.prop("class","Lu-"+e.lineDepthAbs),e.lineType="Lu",e.lineDepthRel=this._findDepthRel(e)}e=e.lineNext}e=r.linePrev;while(e!==null&&e.lineDepthAbs>=r.lineDepthAbs){switch(e.lineType){case"Th":e.line$.prop("class","Tu-"+e.lineDepthAbs),e.lineType="Tu",e.lineDepthRel=this._findDepthRel(e);break;case"Lh":e.line$.prop("class","Lu-"+e.lineDepthAbs),e.lineType="Lu",e.lineDepthRel=this._findDepthRel(e)}e=e.linePrev}break;case"Lh":case"Lu":this.tab(r);break;default:i=!1}i&&(r.line$.prop("class",""+i+"-"+r.lineDepthAbs),r.lineType=i);if(r.lineID===n)break;a.push(r=r.lineNext)}return a},e.prototype._findDepthRel=function(e){var t;if(e.lineDepthAbs===1)return e.lineType[1]==="h"?0:1;t=e.linePrev;while(t!==null&&t.lineDepthAbs>=e.lineDepthAbs)t=t.linePrev;return t!==null?t.lineDepthRel+1:0},e.prototype._toggleLineType=function(){var e,t,n,r,i,s,o,u,a;o=this.getEditorSelection(),s=o.getRangeAt(0),s.startContainer.nodeName==="BODY"?u=s.startContainer.children[s.startOffset]:u=s.startContainer,s.endContainer.nodeName==="BODY"?e=s.endContainer.children[s.endOffset-1]:e=s.endContainer,u.nodeName!=="DIV"&&(u=$(u).parents("div")[0]),e.nodeName!=="DIV"&&(e=$(e).parents("div")[0]),t=e.id,r=this._lines[u.id],a=[];for(;;){switch(r.lineType){case"Tu":i="Th",n=r.lineNext;while(n!==null&&n.lineDepthAbs>=r.lineDepthAbs)n.lineDepthAbs===r.lineDepthAbs&&(n.lineType==="Tu"?(n.line$.prop("class","Th-"+r.lineDepthAbs),n.lineType="Th"):(n.line$.prop("class","Lh-"+r.lineDepthAbs),n.lineType="Lh")),n=n.lineNext;n=r.linePrev;while(n!==null&&n.lineDepthAbs>=r.lineDepthAbs)n.lineDepthAbs===r.lineDepthAbs&&(n.lineType==="Tu"?(n.line$.prop("class","Th-"+r.lineDepthAbs),n.lineType="Th"):(n.line$.prop("class","Lh-"+r.lineDepthAbs),n.lineType="Lh")),n=n.linePrev;break;case"Th":i="Tu",n=r.lineNext;while(n!==null&&n.lineDepthAbs>=r.lineDepthAbs)n.lineDepthAbs===r.lineDepthAbs&&(n.lineType==="Th"?(n.line$.prop("class","Tu-"+r.lineDepthAbs),n.lineType="Tu"):(n.line$.prop("class","Lu-"+r.lineDepthAbs),n.lineType="Lu")),n=n.lineNext;n=r.linePrev;while(n!==null&&n.lineDepthAbs>=r.lineDepthAbs)n.lineDepthAbs===r.lineDepthAbs&&(n.lineType==="Th"?(n.line$.prop("class","Tu-"+r.lineDepthAbs),n.lineType="Tu"):(n.line$.prop("class","Lu-"+r.lineDepthAbs),n.lineType="Lu")),n=n.linePrev;break;default:i=!1}i&&(r.line$.prop("class",""+i+"-"+r.lineDepthAbs),r.lineType=i);if(r.lineID===e.id)break;a.push(r=r.lineNext)}return a},e.prototype.tab=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p;e!=null?(h=e.line$[0],t=h):(c=this.getEditorSelection(),l=c.getRangeAt(0),l.startContainer.nodeName==="BODY"?h=l.startContainer.children[l.startOffset]:h=l.startContainer,l.endContainer.nodeName==="BODY"?t=l.endContainer.children[l.endOffset-1]:t=l.endContainer),h.nodeName!=="DIV"&&(h=$(h).parents("div")[0]),t.nodeName!=="DIV"&&(t=$(t).parents("div")[0]),n=t.id,i=this._lines[h.id],p=[];for(;;){switch(i.lineType){case"Tu":case"Th":u=this._findPrevSibling(i);if(u===null)r=!1;else{r=!0;if(u.lineType==="Th")a="Lh";else{u.lineType==="Tu"?a="Lu":a="Lo";if(i.lineType==="Th"){s=i.lineNext;while(s!==null&&s.lineDepthAbs>i.lineDepthAbs)switch(s.lineType){case"Th":s.lineType="Tu",i.line$.prop("class","Tu-"+s.lineDepthAbs),f=prevTxType;break;case"Tu":f="Lu";break;case"To":f="Lo";break;case"Lh":s.lineType=f,i.line$.prop("class",""+f+"-"+s.lineDepthAbs)}}}}break;case"Lh":case"Lu":case"Lo":s=i.lineNext,a=null;while(s!==null&&s.lineDepthAbs>=i.lineDepthAbs)s.lineDepthAbs!==i.lineDepthAbs+1?s=s.lineNext:(a=s.lineType,s=null);if(a===null){o=i.linePrev;while(o!==null&&o.lineDepthAbs>=i.lineDepthAbs)o.lineDepthAbs===i.lineDepthAbs+1?(a=o.lineType,o=null):o=o.linePrev}if(a===null)r=!0,a="Tu",i.lineDepthAbs+=1,i.lineDepthRel+=1;else{a==="Th"&&(r=!0,i.lineDepthAbs+=1,i.lineDepthRel=0);if(a==="Tu"||a==="To")r=!0,i.lineDepthAbs+=1,i.lineDepthRel+=1}}r&&(i.line$.prop("class",""+a+"-"+i.lineDepthAbs),i.lineType=a);if(i.lineID===n)break;p.push(i=i.lineNext)}return p},e.prototype.shiftTab=function(e){var t,n,r,i,s,o,u,a,f,l,c;e!=null?a=e:(f=this.getEditorSelection(),a=f.getRangeAt(0)),a.startContainer.nodeName==="BODY"?l=a.startContainer.children[a.startOffset]:l=a.startContainer,a.endContainer.nodeName==="BODY"?t=a.endContainer.children[a.endOffset-1]:t=a.endContainer,l.nodeName!=="DIV"&&(l=$(l).parents("div")[0]),t.nodeName!=="DIV"&&(t=$(t).parents("div")[0]),n=t.id,i=this._lines[l.id],c=[];for(;;){switch(i.lineType){case"Tu":case"Th":case"To":u=i.linePrev;while(u!==null&&u.lineDepthAbs>=i.lineDepthAbs)u=u.linePrev;u!==null?(r=!0,s=u.lineType,s="L"+s.charAt(1),i.lineDepthAbs-=1,i.lineDepthRel-=u.lineDepthRel,i.lineNext!=null&&i.lineNext.lineType[0]==="L"&&(o=i.lineNext,o.lineType="T"+o.lineType[1],o.line$.prop("class",""+o.lineType+"-"+o.lineDepthAbs))):r=!1;break;case"Lh":r=!0,s="Th";break;case"Lu":r=!0,s="Tu";break;case"Lo":r=!0,s="To"}r&&(i.line$.prop("class",""+s+"-"+i.lineDepthAbs),i.lineType=s);if(i.lineID===t.id)break;c.push(i=i.lineNext)}return c},e.prototype._return=function(){var e,t,n,r,i,s;return this._findLinesAndIsStartIsEnd(),e=this.currentSel,s=e.startLine,t=e.endLine,e.range.collapsed||(t===s?e.range.deleteContents():(this._deleteMultiLinesSelections(),this._findLinesAndIsStartIsEnd(),e=this.currentSel,s=e.startLine)),e.rangeIsEndLine?(r=this._insertLineAfter({sourceLine:s,targetLineType:s.lineType,targetLineDepthAbs:s.lineDepthAbs,targetLineDepthRel:s.lineDepthRel}),i=rangy.createRange(),i.collapseToPoint(r.line$[0].firstChild,0),e.sel.setSingleRange(i)):e.rangeIsStartLine?(r=this._insertLineBefore({sourceLine:s,targetLineType:s.lineType,targetLineDepthAbs:s.lineDepthAbs,targetLineDepthRel:s.lineDepthRel}),i=rangy.createRange(),i.collapseToPoint(s.line$[0].firstChild,0),e.sel.setSingleRange(i)):(e.range.setEndBefore(s.line$[0].lastChild),n=e.range.extractContents(),e.range.deleteContents(),r=this._insertLineAfter({sourceLine:s,targetLineType:s.lineType,targetLineDepthAbs:s.lineDepthAbs,targetLineDepthRel:s.lineDepthRel,fragment:n}),i=rangy.createRange(),i.collapseToPoint(r.line$[0].firstChild,0),e.sel.setSingleRange(i),this.currentSel=null)},e.prototype._findParent1stSibling=function(e){var t,n;t=e.lineDepthAbs,n=e.linePrev;if(n===null)return e;if(t<=2){while(n.linePrev!==null)n=n.linePrev;return n}while(n!==null&&n.lineDepthAbs>t-2)n=n.linePrev;return n.lineNext},e.prototype._findPrevSibling=function(e){var t,n;t=e.lineDepthAbs,n=e.linePrev;if(n===null)return null;if(n.lineDepthAbs<t)return null;while(n.lineDepthAbs>t)n=n.linePrev;while(n.lineType[0]==="L")n=n.linePrev;return n},e.prototype._deleteMultiLinesSelections=function(e,t){var n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T;y=!0,e!==void 0?(y=!1,v=rangy.createRange(),e===null?(e=t,t=t.lineNext,this._putStartOnStart(v,e.line$[0].firstElementChild),t.line$.prepend("<span></span>"),this._putEndOnStart(v,t.line$[0].firstElementChild)):(S=e.line$[0].lastElementChild.previousElementSibling,o=t.line$[0].lastElementChild.previousElementSibling,v.setStartAfter(S,0),v.setEndAfter(o,0))):(this._findLines(),v=this.currentSel.range,b=v.startContainer,x=v.startOffset,e=this.currentSel.startLine,t=this.currentSel.endLine),s=t.lineDepthAbs,E=e.lineDepthAbs,n=s-E,g=rangy.createRangyRange(),g.setStart(v.endContainer,v.endOffset),g.setEndAfter(t.line$[0].lastChild),u=g.cloneContents(),t.lineType[1]==="h"&&e.lineType[1]!=="h"&&(t.lineType[0]==="L"&&(t.lineType="T"+t.lineType[1],t.line$.prop("class",""+t.lineType+"-"+t.lineDepthAbs)),this.markerList(t)),v.deleteContents(),e.line$[0].lastChild.nodeName==="BR"&&e.line$[0].removeChild(e.line$[0].lastChild),w=u.childNodes[0],c=e.line$[0].lastElementChild;if(w.tagName===(T=c.tagName)&&T==="SPAN"&&w.className===c.className){x=c.textContent.length,p=c.textContent+w.textContent,c.innerHTML=p,b=c.firstChild,f=1;while(f<u.childNodes.length)$(u.childNodes[f]).appendTo(e.line$),f++}else e.line$.append(u);e.lineNext=t.lineNext,t.lineNext!==null&&(t.lineNext.linePrev=e),t.line$.remove(),delete this._lines[t.lineID],l=e.lineNext;if(l!==null){r=l.lineDepthAbs-E;if(r>=1)while(l!==null&&l.lineDepthAbs>=s)h=l.lineDepthAbs-n,l.lineDepthAbs=h,l.line$.prop("class",""+l.lineType+"-"+h),l=l.lineNext}if(l!==null){l.lineType[0]==="L"&&(l.lineType="T"+l.lineType[1],l.line$.prop("class",""+l.lineType+"-"+l.lineDepthAbs)),a=l,i=l.lineDepthAbs,l=l.linePrev;while(l!==null&&l.lineDepthAbs>i)l=l.linePrev;l!==null&&(d=l.lineType,a.lineType!==d&&(d[1]==="h"?this._line2titleList(a):this.markerList(a)))}if(y)return m=rangy.createRange(),m.collapseToPoint(b,x),this.currentSel.sel.setSingleRange(m),this.currentSel=null},e.prototype._insertLineAfter=function(e){var t,n,r,i;return this._highestId+=1,t="CNID_"+this._highestId,e.fragment!=null?(r=$("<div id='"+t+"' class='"+e.targetLineType+"-"+e.targetLineDepthAbs+"'></div>"),r.append(e.fragment),(r[0].childNodes.length===0||r[0].lastChild.nodeName!=="BR")&&r.append("<br>")):e.innerHTML!=null?(r=$("<div id='"+t+"' class='"+e.targetLineType+"-"+e.targetLineDepthAbs+"'>                "+e.innerHTML+"</div>"),r[0].lastChild.nodeName!=="BR"&&r.append("<br>")):(r=$("<div id='"+t+"' class='"+e.targetLineType+"-"+e.targetLineDepthAbs+"'></div>"),r.append($("<span></span><br>"))),i=e.sourceLine,r=r.insertAfter(i.line$),n={line$:r,lineID:t,lineType:e.targetLineType,lineDepthAbs:e.targetLineDepthAbs,lineDepthRel:e.targetLineDepthRel,lineNext:i.lineNext,linePrev:i},this._lines[t]=n,i.lineNext!==null&&(i.lineNext.linePrev=n),i.lineNext=n,n},e.prototype._insertLineBefore=function(e){var t,n,r,i;return this._highestId+=1,t="CNID_"+this._highestId,r=$("<div id='"+t+"' class='"+e.targetLineType+"-"+e.targetLineDepthAbs+"'></div>"),e.fragment!=null?(r.append(e.fragment),r.append($("<br>"))):r.append($("<span></span><br>")),i=e.sourceLine,r=r.insertBefore(i.line$),n={line$:r,lineID:t,lineType:e.targetLineType,lineDepthAbs:e.targetLineDepthAbs,lineDepthRel:e.targetLineDepthRel,lineNext:i,linePrev:i.linePrev},this._lines[t]=n,i.linePrev!==null&&(i.linePrev.lineNext=n),i.linePrev=n,n},e.prototype._findLines=function(){var e,t,n,r,i,s,o,u;if(this.currentSel===null)return s=this.getEditorSelection(),i=s.getRangeAt(0),o=i.startContainer,e=i.endContainer,r=i.startOffset,n=i.endOffset,e.id!=null&&e.id.substr(0,5)==="CNID_"?t=this._lines[e.id]:t=this._lines[$(e).parents("div")[0].id],o.nodeName==="DIV"?u=this._lines[o.id]:u=this._lines[$(o).parents("div")[0].id],this.currentSel={sel:s,range:i,startLine:u,endLine:t,rangeIsStartLine:null,rangeIsEndLine:null}},e.prototype._findLinesAndIsStartIsEnd=function(){var e,t,n,r,i,s,o,u,a,f,l,c,h;if(this.currentSel===null){l=this.getEditorSelection(),u=l.getRangeAt(0),c=u.startContainer,e=u.endContainer,r=u.startOffset,n=u.endOffset;if(e.id!=null&&e.id.substr(0,5)==="CNID_")t=this._lines[e.id],a=e.children.length<n||e.children[n].nodeName==="BR";else{t=this._lines[$(e).parents("div")[0].id],a=!1,e.nodeType===Node.TEXT_NODE?a=e.nextSibling===null&&n===e.textContent.length:a=e.nodeName==="BR"||e.nextSibling.nodeName==="BR"&&e.childNodes.length===n,s=e.parentNode;while(a&&s.nodeName!=="DIV")i=s.nextSibling,a=i===null||i.nodeName==="BR",s=s.parentNode}if(c.nodeName==="DIV")h=this._lines[c.id],f=r===0;else{h=this._lines[$(c).parents("div")[0].id],c.nodeType===Node.TEXT_NODE?f=e.previousSibling===null&&r===0:f=r===0,o=c.parentNode;while(f&&o.nodeName!=="DIV")f=o.previousSibling===null,o=o.parentNode}return t.line$[0].innerHTML==="<span></span><br>"&&(a=!0),h.line$[0].innerHTML==="<span></span><br>"&&(f=!0),this.currentSel={sel:l,range:u,startLine:h,endLine:t,rangeIsStartLine:f,rangeIsEndLine:a}}},e.prototype._readHtml=function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g;d=this.editorBody$.children(),i=0,o=0,a=0,this._lines={},h=null,c=null;for(v=0,m=d.length;v<m;v++)t=d[v],n=$(t),r=(g=n.attr("class"))!=null?g:"",r=r.split("-"),p=r[0],p!==""&&(s=i,i=+r[1],e=i-s,u=o,p==="Th"?o=0:o=u+e,a=parseInt(a,10)+1,f="CNID_"+a,n.prop("id",f),l={line$:n,lineID:f,lineType:p,lineDepthAbs:i,lineDepthRel:o,lineNext:null,linePrev:h},h!==null&&(h.lineNext=l),h=l,this._lines[f]=l);return this._highestId=a},e.prototype._moveLinesDown=function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v;c=this.getEditorSelection(),l=c.getRangeAt(0),l.startContainer.nodeName==="BODY"?h=l.startContainer.children[l.startOffset]:h=l.startContainer,l.endContainer.nodeName==="BODY"?t=l.endContainer.children[l.endOffset-1]:t=l.endContainer,h.nodeName!=="DIV"&&(h=$(h).parents("div")[0]),p=h.id,t.nodeName!=="DIV"&&(t=$(t).parents("div")[0]),n=t.id,u=this._lines[p],i=this._lines[n],o=u.linePrev,s=i.lineNext;if(s!==null){e={line$:s.line$.clone(),lineID:s.lineID,lineType:s.lineType,lineDepthAbs:s.lineDepthAbs,lineDepthRel:s.lineDepthRel,linePrev:s.linePrev,lineNext:s.lineNext},this._deleteMultiLinesSelections(i,s),s=e,this._lines[s.lineID]=s,s.linePrev=o,u.linePrev=s,s.lineNext!==null&&(s.lineNext.linePrev=i),i.lineNext=s.lineNext,s.lineNext=u,o!==null&&(o.lineNext=s),u.line$.before(s.line$);if(o===null)return;if(s.lineDepthAbs<=o.lineDepthAbs){r=s;while(r.lineNext!==null&&r.lineNext.lineDepthAbs>s.lineDepthAbs)r=r.lineNext;r.lineNext!==null&&(r=r.lineNext),a=rangy.createRange(),a.setStart(u.line$[0],0),a.setEnd(r.line$[0],0),f=u.lineDepthAbs-s.lineDepthAbs,s.lineNext.lineType[0]==="T"&&(u.lineType[0]==="T"?f-=1:f+=1),d=[];while(f>=0)this.shiftTab(a),d.push(f-=1);return d}a=rangy.createRange(),a.setStart(s.line$[0],0),a.setEnd(s.line$[0],0),f=s.lineDepthAbs-o.lineDepthAbs,u.lineType[0]==="T"&&(o.lineType[0]==="T"?f-=1:f+=1),v=[];while(f>=0)this.shiftTab(a),v.push(f-=1);return v}},e.prototype._moveLinesUp=function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m;h=this.getEditorSelection(),c=h.getRangeAt(0),c.startContainer.nodeName==="BODY"?p=c.startContainer.children[c.startOffset]:p=c.startContainer,c.endContainer.nodeName==="BODY"?t=c.endContainer.children[c.endOffset-1]:t=c.endContainer,p.nodeName!=="DIV"&&(p=$(p).parents("div")[0]),d=p.id,t.nodeName!=="DIV"&&(t=$(t).parents("div")[0]),n=t.id,a=this._lines[d],s=this._lines[n],u=a.linePrev,o=s.lineNext;if(u!==null){r=u.linePrev===null,e={line$:u.line$.clone(),lineID:u.lineID,lineType:u.lineType,lineDepthAbs:u.lineDepthAbs,lineDepthRel:u.lineDepthRel,linePrev:u.linePrev,lineNext:u.lineNext},this._deleteMultiLinesSelections(u.linePrev,u),r&&($(u.line$[0].firstElementChild).remove(),u.line$.append("<br>"),a.line$=u.line$,a.line$.attr("id",a.lineID),this._lines[a.lineID]=a),u=e,this._lines[u.lineID]=u,u.lineNext=o,s.lineNext=u,u.linePrev!==null&&(u.linePrev.lineNext=a),a.linePrev=u.linePrev,u.linePrev=s,o!==null&&(o.linePrev=u),s.line$.after(u.line$);if(u.lineDepthAbs<=s.lineDepthAbs&&o!==null){i=u;while(i.lineNext!==null&&i.lineNext.lineDepthAbs>u.lineDepthAbs)i=i.lineNext;i.lineNext!==null&&(i=i.lineNext),f=rangy.createRange(),f.setStart(o.line$[0],0),f.setEnd(i.line$[0],0),l=o.lineDepthAbs-u.lineDepthAbs,u.lineNext.lineType[0]==="T"&&(u.lineType[0]==="T"?l-=1:l+=1),v=[];while(l>=0)this.shiftTab(f),v.push(l-=1);return v}f=rangy.createRange(),f.setStart(u.line$[0],0),f.setEnd(u.line$[0],0),l=u.lineDepthAbs-s.lineDepthAbs,u.lineType[0]==="T"&&(s.lineType[0]==="T"?l-=1:l+=1),m=[];while(l>=0)this.shiftTab(f),m.push(l-=1);return m}},e.prototype._addHistory=function(){var e,t;return t=this.saveEditorSelection(),this._history.historySelect.push(t),e={xcoord:this.editorBody$.scrollTop(),ycoord:this.editorBody$.scrollLeft()},this._history.historyScroll.push(e),this._history.historyPos.push(this.newPosition),this._history.history.push(this.editorBody$.html()),rangy.removeMarkers(t),this._history.index=this._history.history.length-1},e.prototype.undoPossible=function(){return this._history.index>0},e.prototype.redoPossible=function(){return this._history.index<this._history.history.length-2},e.prototype.unDo=function(){var e,t,n;if(this.undoPossible())return this._history.index===this._history.history.length-1&&(this._addHistory(),this._history.index-=1),this.newPosition=this._history.historyPos[this._history.index],this.editorBody$.html(this._history.history[this._history.index]),e=this._history.historySelect[this._history.index],e.restored=!1,rangy.restoreSelection(e),t=this._history.historyScroll[this._history.index].xcoord,n=this._history.historyScroll[this._history.index].ycoord,this.editorBody$.scrollTop(t),this.editorBody$.scrollLeft(n),this._readHtml(),this._history.index-=1},e.prototype.reDo=function(){var e,t,n;if(this.redoPossible())return this.newPosition=this._history.historyPos[this._history.index+1],this._history.index+=1,this.editorBody$.html(this._history.history[this._history.index+1]),e=this._history.historySelect[this._history.index+1],e.restored=!1,rangy.restoreSelection(e),t=this._history.historyScroll[this._history.index+1].xcoord,n=this._history.historyScroll[this._history.index+1].ycoord,this.editorBody$.scrollTop(t),this.editorBody$.scrollLeft(n),this._readHtml()},e.prototype._initSummary=function(){var e;return e=this.editorBody$.children("#navi"),e.length===0&&(e=$(document.createElement("div")),e.attr("id","navi"),e.prependTo(this.editorBody$)),e},e.prototype._buildSummary=function(){var e,t,n,r;n=this.initSummary(),this.editorBody$.children("#navi").children().remove(),t=this._lines,r=[];for(e in t)this.editorBody$.children("#"+(""+t[e].lineID)).length>0&&t[e].lineType==="Th"?r.push(t[e].line$.clone().appendTo(n)):r.push(void 0);return r},e.prototype.paste=function(e){var t,n,r;return t=this.clipboard,this._findLinesAndIsStartIsEnd(),n=rangy.createRange(),n.selectNodeContents(t),r=this.getEditorSelection(),r.setSingleRange(n),n.detach(),e&&e.clipboardData&&e.clipboardData.getData?(e.clipboardData.types==="text/html"?t.innerHTML=e.clipboardData.getData("text/html"):e.clipboardData.types==="text/plain"?t.innerHTML=e.clipboardData.getData("text/plain"):t.innerHTML="",this._waitForPasteData(t,this._processPaste),e.preventDefault&&(e.stopPropagation(),e.preventDefault()),!1):(t.innerHTML="",this._waitForPasteData(t,this._processPaste),!0)},e.prototype._initClipBoard=function(){var e,t,n;return t=$(document.createElement("div")),n={left:-300},t.offset(n),t.prependTo(this.editorBody$),e=t[0],e.style.setProperty("width","280px"),e.style.setProperty("position","fixed"),e.style.setProperty("overflow","hidden"),this.clipboard=e,e},e.prototype._waitForPasteData=function(e,t){var n;return(n=function(e){var r;return e.childNodes&&e.childNodes.length>0?t():(r={e:e},r.callself=function(){return n(r.e)},setTimeout(r.callself,10))})(e)},e.prototype._processPaste=function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A;x=this.clipboard,r=this.currentSel,E=x.innerHTML,E=sanitize(E).xss(),x.innerHTML=E,h=document.createDocumentFragment(),o={lineNext:null,linePrev:null,line$:$("<div id='dummy' class='Tu-1'></div>")},h.appendChild(o.line$[0]),i=document.createDocumentFragment(),e=r.startLine.lineDepthAbs,r.startLine.lineType==="Th"&&(e+=1),s={absDepth:e,prevHxLevel:null,frag:h,prevCNLineAbsDepth:null,lastAddedLine:o,currentLineFrag:i,currentLineEl:i,isCurrentLineBeingPopulated:!1},p=this._domWalk(x,s),x.innerHTML="",h.removeChild(h.firstChild),d=0;while(d<h.childNodes.length)v=h.childNodes[d],A=v.textContent,v.innerHTML="<span></span><br>",v.firstChild.appendChild(document.createTextNode(A)),d+=1;N=r.startLine,a=r.endLine,r.range.collapsed||(a===N?r.range.deleteContents():(this._deleteMultiLinesSelections(),r=this._findLinesAndIsStartIsEnd(),N=r.startLine)),k=r.range.startContainer,C=r.range.startOffset,k.length?f=k.length-C:f=k.childNodes.length-C,d=0,m=h.firstChild.childNodes,y=m.length;while(d<y-1)u=m[d],d+=1,u.tagName==="SPAN"&&(k.tagName==="SPAN"||k.nodeType===Node.TEXT_NODE)&&(L=k.textContent,b=L.substr(0,C),b+=u.textContent,b+=L.substr(C),k.textContent=b,C+=u.textContent.length);if(h.childNodes.length>1){S=document.createRange(),S.setStart(k,C),w=k;while(w.tagName!=="DIV")w=w.parentElement;S.setEnd(w,w.children.length-1),l=S.extractContents(),S.detach(),this._insertFrag(h.lastChild,h.lastChild.children.length-1,l),w=k;while(w.tagName!=="DIV")w=w.parentElement}return c=o.lineNext,T=c.lineNext,h.removeChild(h.firstChild),delete this._lines[c.lineID],T!==null&&(g=r.startLine.lineNext,r.startLine.lineNext=T,T.linePrev=r.startLine,g===null?this.editorBody$[0].appendChild(h):(s.lastAddedLine.lineNext=g,g.linePrev=s.lastAddedLine,this.editorBody$[0].insertBefore(h,g.line$[0]))),T!==null?(n=g.linePrev.line$[0].childNodes[0].firstChild,t=n.length-f,r.sel.collapse(n,t)):r.sel.collapse(k,C)},e.prototype._insertFrag=function(e,t,n){var r,i;if(t===0)return r=document.createRange(),r.setStart(startContainer,startOffset),r.setEnd(startContainer,startOffset),r.insertNode(n),r.detach();if(n.childNodes.length>0)return i=e.childNodes[t-1],i.textContent+=n.firstChild.textContent},e.prototype._domWalk=function(e,t){var n;this.__domWalk(e,t);if(t.currentLineFrag.childNodes.length>0)return n={sourceLine:t.lastAddedLine,fragment:t.currentLineFrag,targetLineType:"Tu",targetLineDepthAbs:t.absDepth,targetLineDepthRel:t.absDepth},t.lastAddedLine=this._insertLineAfter(n)},e.prototype.__domWalk=function(e,t){var n,r,i,s,o,u,a,f,l,c,h,p;n=t.absDepth,o=t.prevHxLevel,h=e.childNodes;for(l=0,c=h.length;l<c;l++){r=h[l];switch(r.nodeName){case"#text":f=document.createTextNode(r.textContent),(p=t.currentLineEl.nodeName)==="SPAN"||p==="A"?t.currentLineEl.appendChild(f):(a=document.createElement("span"),a.appendChild(f),t.currentLineEl.appendChild(a)),t.isCurrentLineBeingPopulated=!0;break;case"P":case"UL":case"OL":t.absDepth=n,this.__domWalk(r,t),t.isCurrentLineBeingPopulated&&this._appendCurrentLineFrag(t,n,n);break;case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":i=0,this.__domWalk(r,t),t.isCurrentLineBeingPopulated&&this._appendCurrentLineFrag(t,Math.min(0,i)+n,Math.min(0,i)+n);break;case"LI":t.isCurrentLineBeingPopulated&&this._appendCurrentLineFrag(t,n,n),this.__domWalk(r,t),t.isCurrentLineBeingPopulated&&this._appendCurrentLineFrag(t,n,n);break;case"BR":this._appendCurrentLineFrag(t,n,n);break;case"A":s=t.currentLineEl.lastChild,s!==null&&s.nodeName==="SPAN"?s.textContent+="[["+r.textContent+"|"+r.href+"]]":(u=document.createElement("span"),u.textContent=r.textContent+" [["+r.href+"]] ",t.currentLineEl.appendChild(u)),t.isCurrentLineBeingPopulated=!0;break;case"DIV":r.id.substr(0,5)==="CNID_"?this._clipBoard_Insert_InternalLine(r,t):this.__domWalk(r,t);break;default:s=t.currentLineEl.lastChild,s!==null&&s.nodeName==="SPAN"?s.textContent+=r.textContent:(u=document.createElement("span"),u.textContent=r.textContent,t.currentLineEl.appendChild(u)),t.isCurrentLineBeingPopulated=!0}}return!0},e.prototype._appendCurrentLineFrag=function(e,t,n){var r,i;return e.currentLineFrag.childNodes.length===0&&(i=document.createElement("span"),e.currentLineFrag.appendChild(i)),r={sourceLine:e.lastAddedLine,fragment:e.currentLineFrag,targetLineType:"Tu",targetLineDepthAbs:t,targetLineDepthRel:t},e.lastAddedLine=this._insertLineAfter(r),e.currentLineFrag=document.createDocumentFragment(),e.currentLineEl=e.currentLineFrag,e.isCurrentLineBeingPopulated=!1},e.prototype._clipBoard_Insert_InternalLine=function(e,t){var n,r,i,s;return r=e.className.split("-"),i=+r[1],r=r[0],t.prevCNLineAbsDepth||(t.prevCNLineAbsDepth=i),n=i-t.prevCNLineAbsDepth,n>0,s={sourceLine:t.lastAddedLine,innerHTML:e.innerHTML,targetLineType:"Tu",targetLineDepthAbs:t.absDepth,targetLineDepthRel:t.absDepth},t.lastAddedLine=this._insertLineAfter(s)},e.prototype._cozy2md=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d,v;s=$(document.createElement("div")).html(e),c="",i=0,r={A:function(e){var t,n;return n=e.attr("title")!=null?e.attr("title"):"",t=e.attr("href")!=null?e.attr("href"):"","["+e.html()+"]("+t+' "'+n+'")'},IMG:function(e){var t,n,r;return r=e.attr("title")!=null?e.attr("title"):"",t=e.attr("alt")!=null?e.attr("alt"):"",n=e.attr("src")!=null?e.attr("src"):"","!["+t+"]("+n+' "'+r+'")'},SPAN:function(e){return e.text()}},h={Th:function(e,t){var n,r;i=t,n="",r=0;while(r<t)n+="#",r++;return"\n"+n+" "},Lh:function(e,t){return"\n"},Tu:function(e,t){return"\n"+e+"+   "},Lu:function(e,t){return"\n"+e+"    "},To:function(e,t){return"\n"+e+"1.   "},Lo:function(e,t){return"\n"+e+"    "}},n=function(e){var t,n,r,s,o;s=e.split("-"),o=s[0],n=parseInt(s[1],10),t="",r=1;while(r<n-i)t+="    ",r++;return h[o](t,n)},t=s.children();for(o=d=0,v=t.length-1;0<=v?d<=v:d>=v;o=0<=v?++d:--d){f=$(t.get(o)),f.attr("class")!=null&&(c+=n(f.attr("class"))),a=f.children().length,u=0,p=" ";while(u<a)l=f.children().get(u),u+2===a&&(p=""),l.nodeType===1&&r[l.nodeName]!=null?c+=r[l.nodeName]($(l))+p:c+=$(l).text()+p,u++;c+="\n"}return c},e.prototype._md2cozy=function(e){var t,n,r,i,s,o,u,a;return t=new Showdown.converter,e=t.makeHtml(e),s=$(document.createElement("ul")).html(e),n="",o=0,r=function(e,t,n){var r;return o++,r="",n.contents().each(function(){var e;e=this.nodeName;if(e==="#text")return r+="<span>"+$(this).text()+"</span>";if(this.tagName!=null)return $(this).wrap("<div></div>"),r+=""+$(this).parent().html(),$(this).unwrap()}),"<div id=CNID_"+o+" class="+e+"-"+t+">"+r+"<br></div>"},i=0,u=function(e){var t;return t=e[0].tagName,t[0]==="H"?(i=parseInt(t[1],10),n+=r("Th",i,e)):t==="P"?n+=r("Lh",i,e):a(e,"u")},a=function(e,t){var s,o,u,f,l,c;u=e[0].tagName;if(u==="UL")return i++,e.children().each(function(){return a($(this),"u")}),i--;if(u==="OL")return i++,e.children().each(function(){return a($(this),"o")}),i--;if(u==="LI"&&e.contents().get(0)!=null){e.contents().get(0).nodeName==="#text"&&(e=e.clone().wrap("<p></p>").parent()),c=[];for(o=f=0,l=e.children().length-1;0<=l?f<=l:f>=l;o=0<=l?++f:--f)s=$(e.children().get(o)),o===0?c.push(n+=r("T"+t,i,s)):c.push(a(s,t));return c}if(u==="P")return n+=r("L"+t,i,e)},s.children().each(function(){return u($(this))}),n},e}();var __bind=function(e,t){return function(){return e.apply(t,arguments)}};exports.CNeditor=function(){function e(e,t){this._processPaste=__bind(this._processPaste,this),this._keyPressListener=__bind(this._keyPressListener,this);var n,r,i,s=this;e.nodeName==="IFRAME"?(console.log("et hop !"),this.getEditorSelection=function(){return rangy.getIframeSelection(e)},this.saveEditorSelection=function(){return rangy.saveSelection(rangy.dom.getIframeWindow(e))},r=$(e),r.on("load",function(){var n,i,o;return o=r.contents().find("html"),n=o.find("body"),n.parent().attr("id","__ed-iframe-html"),n.attr("contenteditable","true"),n.attr("id","__ed-iframe-body"),s.document=n[0].ownerDocument,i=o.find("head"),i.html('<link id="editorCSS" href="stylesheets/CNeditor.css" rel="stylesheet">'),s.editorBody$=n,s.editorTarget=e,s._lines={},s.newPosition=!0,s._highestId=0,s._deepest=1,s._firstLine=null,s._history={index:0,history:[null],historySelect:[null],historyScroll:[null],historyPos:[null]},s._lastKey=null,n.prop("__editorCtl",s),n.on("mouseup",function(){return s.newPosition=!0}),n.on("keydown",s._keyPressListener),n.on("keyup",function(){return r.trigger(jQuery.Event("onKeyUp"))}),n.on("click",function(e){return s._lastKey=null}),n.on("paste",function(e){return console.log("pasting..."),s.paste(e)}),s._initClipBoard(),t.call(s),s}),e.src=""):(console.log("target is not an iframe..."),this.getEditorSelection=function(){return rangy.getSelection()},this.saveEditorSelection=function(){return rangy.saveSelection()},i=$(e),n=function(){var n;return n=i,n.attr("contenteditable","true"),n.attr("id","__ed-iframe-body"),s.editorBody$=n,s.editorTarget=e,s._lines={},s.newPosition=!0,s._highestId=0,s._deepest=1,s._firstLine=null,s._history={index:0,history:[null],historySelect:[null],historyScroll:[null],historyPos:[null]},s._lastKey=null,n.prop("__editorCtl",s),n.on("keydown",s._keyPressListener),n.on("mouseup",function(){return s.newPosition=!0}),n.on("keyup",function(){return i.trigger(jQuery.Event("onKeyUp"))}),n.on("click",function(e){return s._lastKey=null}),n.on("paste",function(e){return console.log("pasting..."),s.paste(e)}),t.call(s),s},n(),this._initClipBoard())}return e.prototype._updateDeepest=function(){var e,t,n;n=1,t=this._lines;for(e in t)this.editorBody$.children("#"+(""+t[e].lineID)).length>0&&t[e].lineType==="Th"&&t[e].lineDepthAbs>n&&(n=this._lines[e].lineDepthAbs);if(n!==this._deepest)return this._deepest=n,n<4?this.replaceCSS("stylesheets/app-deep-"+n+".css"):this.replaceCSS("stylesheets/app-deep-4.css")},e.prototype.replaceContent=function(e){return this.editorBody$.html(e),this._readHtml(),this._initClipBoard()},e.prototype.deleteContent=function(){return this.editorBody$.html('<div id="CNID_1" class="Tu-1"><span></span><br></div>'),this._readHtml(),this._initClipBoard()},e.prototype.getEditorContent=function(){var e;return e=this.editorBody$.html(),this._cozy2md(e)},e.prototype.setEditorContent=function(e){var t;return t=this._md2cozy(e),this.editorBody$.html(t),this._readHtml(),this._initClipBoard()},e.prototype.replaceCSS=function(e){var t,n;return t=this.document,n=t.querySelector("#editorCSS"),n.setAttribute("href",e),t.head.appendChild(n)},e.prototype._putEndOnEnd=function(e,t){var n,r;return t.lastChild!=null?(r=t.lastChild.textContent.length,r===0&&(t.lastChild.data=" ",r=1),e.setEnd(t.lastChild,r)):(n=document.createTextNode(" "),t.appendChild(n),e.setEnd(n,1))},e.prototype._putStartOnEnd=function(e,t){var n,r;return t.lastChild!=null?(r=t.lastChild.textContent.length,r===0&&(t.lastChild.data=" ",r=1),e.setStart(t.lastChild,r)):(n=document.createTextNode(" "),t.appendChild(n),e.setStart(n,0))},e.prototype._putEndOnStart=function(e,t){var n,r;return t.firstChild!=null?(r=t.firstChild.textContent.length,r===0&&(t.firstChild.data=" "),e.setEnd(t.firstChild,0)):(n=document.createTextNode(" "),t.appendChild(n),e.setEnd(n,0))},e.prototype._putStartOnStart=function(e,t){var n,r;return t.firstChild!=null?(r=t.firstChild.textContent.length,r===0&&(t.firstChild.data=" "),e.setStart(t.firstChild,0)):(n=document.createTextNode(" "),t.appendChild(n),e.setStart(n,0))},e.prototype._normalize=function(e){var t,n,r,i,s,o,u,a,f;e.startContainer.nodeName==="BODY"?o=e.startContainer.children[e.startOffset]:o=e.startContainer,e.endContainer.nodeName==="BODY"?r=e.endContainer.children[e.endOffset-1]:r=e.endContainer,o.nodeName!=="DIV"&&(o=$(o).parents("div")[0]),r.nodeName!=="DIV"&&(r=$(r).parents("div")[0]),o===r&&o.innerHTML==="<span></span><br>"&&(this.isEmptyLine=!0),s=e.startContainer;if(s.nodeName==="BODY")t=s.children[e.startOffset].firstChild,this._putStartOnStart(e,t);else if(s.nodeName==="DIV")this.isEmptyLine?(t=s.childNodes[0],this._putStartOnStart(e,t)):e.startOffset<s.childNodes.length-1?(t=s.childNodes[e.startOffset],this._putStartOnStart(e,t)):(t=s.lastChild.previousElementSibling,this._putStartOnEnd(e,t));else if((a=s.nodeName)==="SPAN"||a==="IMG"||a==="A")s.firstChild===null||s.textContent.length===0?this._putStartOnEnd(e,s):e.startOffset<s.childNodes.length?(u=s.childNodes[e.startOffset],e.setStart(u,0)):(u=s.lastChild,i=u.data.length,e.setStart(u,i));n=e.endContainer,n.nodeName==="BODY"&&(t=n.children[e.endOffset-1].lastChild,this._putEndOnEnd(e,t.previousElementSibling));if(n.nodeName==="DIV")e.endOffset<n.childNodes.length-1?(t=n.childNodes[e.endOffset],this._putEndOnStart(e,t)):(t=n.lastChild.previousElementSibling,this._putEndOnEnd(e,t));else if((f=n.nodeName)==="SPAN"||f==="IMG"||f==="A")(n.firstChild===null||n.textContent.length===0)&&this._putEndOnEnd(e,n),e.endOffset<n.childNodes.length?(u=s.childNodes[e.endOffset],e.setEnd(u,0)):(u=n.lastChild,i=u.data.length,e.setEnd(u,i));return e},e.prototype._keyPressListener=function(e){var t,n,r,i,s,o,u;n=(e.altKey?"Alt":"")+(e.ctrlKey?"Ctrl":"")+(e.shiftKey?"Shift":"");switch(e.keyCode){case 13:t="return";break;case 35:t="end";break;case 36:t="home";break;case 33:t="pgUp";break;case 34:t="pgDwn";break;case 37:t="left";break;case 38:t="up";break;case 39:t="right";break;case 40:t="down";break;case 9:t="tab";break;case 8:t="backspace";break;case 32:t="space";break;case 27:t="esc";break;case 46:t="suppr";break;case 16:e.preventDefault();return;case 17:e.preventDefault();return;case 18:e.preventDefault();return;default:switch(e.which){case 32:t="space";break;case 8:t="backspace";break;case 65:t="A";break;case 83:t="S";break;case 86:t="V";break;case 89:t="Y";break;case 90:t="Z";break;default:t="other"}}u=n+"-"+t;if(u==="-A"||u==="-S"||u==="-V"||u==="-Y"||u==="-Z")u="-other";this._lastKey!==u&&(u==="-tab"||u==="-return"||u==="-backspace"||u==="-suppr"||u==="CtrlShift-down"||u==="CtrlShift-up"||u==="CtrlShift-left"||u==="CtrlShift-right"||u==="Ctrl-V"||u==="Shift-tab"||u==="-space"||u==="-other")&&this._addHistory(),this._lastKey=u,this.newPosition&&(u==="-other"||u==="-space"||u==="-suppr"||u==="-backspace"||u==="-return")&&(this.newPosition=!1,o=this.getEditorSelection(),s=o.getRangeAt(0),r=rangy.createRange(),r=this._normalize(s),i=this.getEditorSelection(),i.setSingleRange(r)),(t==="left"||t==="up"||t==="right"||t==="down"||t==="pgUp"||t==="pgDwn"||t==="end"||t==="home"||t==="return"||t==="suppr"||t==="backspace")&&u!=="CtrlShift-down"&&u!=="CtrlShift-up"&&u!=="CtrlShift-right"&&u!=="CtrlShift-left"&&(this.newPosition=!0),this.currentSel=null;switch(u){case"-return":return this._return(),e.preventDefault();case"-tab":return this.tab(),e.preventDefault();case"CtrlShift-right":return this.tab(),e.preventDefault();case"-backspace":return this._backspace(e);case"-suppr":return this._suppr(e);case"CtrlShift-down":return this._moveLinesDown(),e.preventDefault();case"CtrlShift-up":return this._moveLinesUp(),e.preventDefault();case"Shift-tab":return this.shiftTab(),e.preventDefault();case"CtrlShift-left":return this.shiftTab(),e.preventDefault();case"Alt-A":return this._toggleLineType(),e.preventDefault();case"Ctrl-V":return!0;case"Ctrl-S":return $(this.editorTarget).trigger(jQuery.Event("saveRequest")),e.preventDefault();case"Ctrl-Z":return e.preventDefault(),this.unDo();case"Ctrl-Y":return e.preventDefault(),this.reDo()}},e.prototype._suppr=function(e){var t,n;this._findLinesAndIsStartIsEnd(),t=this.currentSel,this.isEmptyLine&&(this.isEmptyLine=!1,t.range.deleteContents()),n=t.startLine;if(!t.range.collapsed)return t.endLine===n?(t.range.deleteContents(),e.preventDefault()):(this._deleteMultiLinesSelections(),e.preventDefault());if(t.rangeIsEndLine)return n.lineNext!==null?(t.range.setEndBefore(n.lineNext.line$[0].firstChild),t.endLine=n.lineNext,this._deleteMultiLinesSelections(),e.preventDefault()):e.preventDefault()},e.prototype._backspace=function(e){var t,n;this._findLinesAndIsStartIsEnd(),t=this.currentSel,this.isEmptyLine&&(this.isEmptyLine=!1,t.range.deleteContents()),n=t.startLine;if(!t.range.collapsed)return t.endLine===n?(t.range.deleteContents(),e.preventDefault()):(this._deleteMultiLinesSelections(),e.preventDefault());if(t.rangeIsStartLine)return n.linePrev!==null?(t.range.setStartBefore(n.linePrev.line$[0].lastChild),t.startLine=n.linePrev,this._deleteMultiLinesSelections(),e.preventDefault()):e.preventDefault()},e.prototype.titleList=function(){var e,t,n,r,i,s,o,u;s=this.getEditorSelection(),i=s.getRangeAt(0),i.startContainer.nodeName==="BODY"?o=i.startContainer.children[i.startOffset]:o=i.startContainer,i.endContainer.nodeName==="BODY"?e=i.endContainer.children[i.endOffset-1]:e=i.endContainer,o.nodeName!=="DIV"&&(o=$(o).parents("div")[0]),e.nodeName!=="DIV"&&(e=$(e).parents("div")[0]),n=e.id,r=this._lines[o.id],t=e.id,u=[];for(;;){this._line2titleList(r);if(r.lineID===t)break;u.push(r=r.lineNext)}return u},e.prototype._line2titleList=function(e){var t,n;if(e.lineType!=="Th"){e.lineType[0]==="L"&&(e.lineType="Tu",e.lineDepthAbs+=1),this._titilizeSiblings(e),t=this._findParent1stSibling(e),n=[];while(t!==null&&t.lineType!=="Th")this._titilizeSiblings(t),n.push(t=this._findParent1stSibling(t));return n}},e.prototype._titilizeSiblings=function(e){var t,n;n=e.lineDepthAbs,t=e;while(t!==null&&t.lineDepthAbs>=n){if(t.lineDepthAbs===n)switch(t.lineType){case"Tu":case"To":t.line$.prop("class","Th-"+n),t.lineType="Th",t.lineDepthRel=0;break;case"Lu":case"Lo":t.line$.prop("class","Lh-"+n),t.lineType="Lh",t.lineDepthRel=0}t=t.lineNext}t=e.linePrev;while(t!==null&&t.lineDepthAbs>=n){if(t.lineDepthAbs===n)switch(t.lineType){case"Tu":case"To":t.line$.prop("class","Th-"+n),t.lineType="Th",t.lineDepthRel=0;break;case"Lu":case"Lo":t.line$.prop("class","Lh-"+n),t.lineType="Lh",t.lineDepthRel=0}t=t.linePrev}return!0},e.prototype.markerList=function(e){var t,n,r,i,s,o,u,a;e!=null?(u=e.lineID,n=u):(s=this.getEditorSelection().getRangeAt(0),s.startContainer.nodeName==="BODY"?o=s.startContainer.children[s.startOffset]:o=s.startContainer,s.endContainer.nodeName==="BODY"?t=s.endContainer.children[s.endOffset-1]:t=s.endContainer,o.nodeName!=="DIV"&&(o=$(o).parents("div")[0]),u=o.id,t.nodeName!=="DIV"&&(t=$(t).parents("div")[0]),n=t.id),r=this._lines[u],a=[];for(;;){switch(r.lineType){case"Th":i="Tu",e=r.lineNext;while(e!==null&&e.lineDepthAbs>=r.lineDepthAbs){switch(e.lineType){case"Th":e.line$.prop("class","Tu-"+e.lineDepthAbs),e.lineType="Tu",e.lineDepthRel=this._findDepthRel(e);break;case"Lh":e.line$.prop("class","Lu-"+e.lineDepthAbs),e.lineType="Lu",e.lineDepthRel=this._findDepthRel(e)}e=e.lineNext}e=r.linePrev;while(e!==null&&e.lineDepthAbs>=r.lineDepthAbs){switch(e.lineType){case"Th":e.line$.prop("class","Tu-"+e.lineDepthAbs),e.lineType="Tu",e.lineDepthRel=this._findDepthRel(e);break;case"Lh":e.line$.prop("class","Lu-"+e.lineDepthAbs),e.lineType="Lu",e.lineDepthRel=this._findDepthRel(e)}e=e.linePrev}break;case"Lh":case"Lu":this.tab(r);break;default:i=!1}i&&(r.line$.prop("class",""+i+"-"+r.lineDepthAbs),r.lineType=i);if(r.lineID===n)break;a.push(r=r.lineNext)}return a},e.prototype._findDepthRel=function(e){var t;if(e.lineDepthAbs===1)return e.lineType[1]==="h"?0:1;t=e.linePrev;while(t!==null&&t.lineDepthAbs>=e.lineDepthAbs)t=t.linePrev;return t!==null?t.lineDepthRel+1:0},e.prototype._toggleLineType=function(){var e,t,n,r,i,s,o,u,a;o=this.getEditorSelection(),s=o.getRangeAt(0),s.startContainer.nodeName==="BODY"?u=s.startContainer.children[s.startOffset]:u=s.startContainer,s.endContainer.nodeName==="BODY"?e=s.endContainer.children[s.endOffset-1]:e=s.endContainer,u.nodeName!=="DIV"&&(u=$(u).parents("div")[0]),e.nodeName!=="DIV"&&(e=$(e).parents("div")[0]),t=e.id,r=this._lines[u.id],a=[];for(;;){switch(r.lineType){case"Tu":i="Th",n=r.lineNext;while(n!==null&&n.lineDepthAbs>=r.lineDepthAbs)n.lineDepthAbs===r.lineDepthAbs&&(n.lineType==="Tu"?(n.line$.prop("class","Th-"+r.lineDepthAbs),n.lineType="Th"):(n.line$.prop("class","Lh-"+r.lineDepthAbs),n.lineType="Lh")),n=n.lineNext;n=r.linePrev;while(n!==null&&n.lineDepthAbs>=r.lineDepthAbs)n.lineDepthAbs===r.lineDepthAbs&&(n.lineType==="Tu"?(n.line$.prop("class","Th-"+r.lineDepthAbs),n.lineType="Th"):(n.line$.prop("class","Lh-"+r.lineDepthAbs),n.lineType="Lh")),n=n.linePrev;break;case"Th":i="Tu",n=r.lineNext;while(n!==null&&n.lineDepthAbs>=r.lineDepthAbs)n.lineDepthAbs===r.lineDepthAbs&&(n.lineType==="Th"?(n.line$.prop("class","Tu-"+r.lineDepthAbs),n.lineType="Tu"):(n.line$.prop("class","Lu-"+r.lineDepthAbs),n.lineType="Lu")),n=n.lineNext;n=r.linePrev;while(n!==null&&n.lineDepthAbs>=r.lineDepthAbs)n.lineDepthAbs===r.lineDepthAbs&&(n.lineType==="Th"?(n.line$.prop("class","Tu-"+r.lineDepthAbs),n.lineType="Tu"):(n.line$.prop("class","Lu-"+r.lineDepthAbs),n.lineType="Lu")),n=n.linePrev;break;default:i=!1}i&&(r.line$.prop("class",""+i+"-"+r.lineDepthAbs),r.lineType=i);if(r.lineID===e.id)break;a.push(r=r.lineNext)}return a},e.prototype.tab=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p;e!=null?(h=e.line$[0],t=h):(c=this.getEditorSelection(),l=c.getRangeAt(0),l.startContainer.nodeName==="BODY"?h=l.startContainer.children[l.startOffset]:h=l.startContainer,l.endContainer.nodeName==="BODY"?t=l.endContainer.children[l.endOffset-1]:t=l.endContainer),h.nodeName!=="DIV"&&(h=$(h).parents("div")[0]),t.nodeName!=="DIV"&&(t=$(t).parents("div")[0]),n=t.id,i=this._lines[h.id],p=[];for(;;){switch(i.lineType){case"Tu":case"Th":u=this._findPrevSibling(i);if(u===null)r=!1;else{r=!0;if(u.lineType==="Th")a="Lh";else{u.lineType==="Tu"?a="Lu":a="Lo";if(i.lineType==="Th"){s=i.lineNext;while(s!==null&&s.lineDepthAbs>i.lineDepthAbs)switch(s.lineType){case"Th":s.lineType="Tu",i.line$.prop("class","Tu-"+s.lineDepthAbs),f=prevTxType;break;case"Tu":f="Lu";break;case"To":f="Lo";break;case"Lh":s.lineType=f,i.line$.prop("class",""+f+"-"+s.lineDepthAbs)}}}}break;case"Lh":case"Lu":case"Lo":s=i.lineNext,a=null;while(s!==null&&s.lineDepthAbs>=i.lineDepthAbs)s.lineDepthAbs!==i.lineDepthAbs+1?s=s.lineNext:(a=s.lineType,s=null);if(a===null){o=i.linePrev;while(o!==null&&o.lineDepthAbs>=i.lineDepthAbs)o.lineDepthAbs===i.lineDepthAbs+1?(a=o.lineType,o=null):o=o.linePrev}if(a===null)r=!0,a="Tu",i.lineDepthAbs+=1,i.lineDepthRel+=1;else{a==="Th"&&(r=!0,i.lineDepthAbs+=1,i.lineDepthRel=0);if(a==="Tu"||a==="To")r=!0,i.lineDepthAbs+=1,i.lineDepthRel+=1}}r&&(i.line$.prop("class",""+a+"-"+i.lineDepthAbs),i.lineType=a);if(i.lineID===n)break;p.push(i=i.lineNext)}return p},e.prototype.shiftTab=function(e){var t,n,r,i,s,o,u,a,f,l,c;e!=null?a=e:(f=this.getEditorSelection(),a=f.getRangeAt(0)),a.startContainer.nodeName==="BODY"?l=a.startContainer.children[a.startOffset]:l=a.startContainer,a.endContainer.nodeName==="BODY"?t=a.endContainer.children[a.endOffset-1]:t=a.endContainer,l.nodeName!=="DIV"&&(l=$(l).parents("div")[0]),t.nodeName!=="DIV"&&(t=$(t).parents("div")[0]),n=t.id,i=this._lines[l.id],c=[];for(;;){switch(i.lineType){case"Tu":case"Th":case"To":u=i.linePrev;while(u!==null&&u.lineDepthAbs>=i.lineDepthAbs)u=u.linePrev;u!==null?(r=!0,s=u.lineType,s="L"+s.charAt(1),i.lineDepthAbs-=1,i.lineDepthRel-=u.lineDepthRel,i.lineNext!=null&&i.lineNext.lineType[0]==="L"&&(o=i.lineNext,o.lineType="T"+o.lineType[1],o.line$.prop("class",""+o.lineType+"-"+o.lineDepthAbs))):r=!1;break;case"Lh":r=!0,s="Th";break;case"Lu":r=!0,s="Tu";break;case"Lo":r=!0,s="To"}r&&(i.line$.prop("class",""+s+"-"+i.lineDepthAbs),i.lineType=s);if(i.lineID===t.id)break;c.push(i=i.lineNext)}return c},e.prototype._return=function(){var e,t,n,r,i,s;return this._findLinesAndIsStartIsEnd(),e=this.currentSel,s=e.startLine,t=e.endLine,e.range.collapsed||(t===s?e.range.deleteContents():(this._deleteMultiLinesSelections(),this._findLinesAndIsStartIsEnd(),e=this.currentSel,s=e.startLine)),e.rangeIsEndLine?(r=this._insertLineAfter({sourceLine:s,targetLineType:s.lineType,targetLineDepthAbs:s.lineDepthAbs,targetLineDepthRel:s.lineDepthRel}),i=rangy.createRange(),i.collapseToPoint(r.line$[0].firstChild,0),e.sel.setSingleRange(i)):e.rangeIsStartLine?(r=this._insertLineBefore({sourceLine:s,targetLineType:s.lineType,targetLineDepthAbs:s.lineDepthAbs,targetLineDepthRel:s.lineDepthRel}),i=rangy.createRange(),i.collapseToPoint(s.line$[0].firstChild,0),e.sel.setSingleRange(i)):(e.range.setEndBefore(s.line$[0].lastChild),n=e.range.extractContents(),e.range.deleteContents(),r=this._insertLineAfter({sourceLine:s,targetLineType:s.lineType,targetLineDepthAbs:s.lineDepthAbs,targetLineDepthRel:s.lineDepthRel,fragment:n}),i=rangy.createRange(),i.collapseToPoint(r.line$[0].firstChild,0),e.sel.setSingleRange(i),this.currentSel=null)},e.prototype._findParent1stSibling=function(e){var t,n;t=e.lineDepthAbs,n=e.linePrev;if(n===null)return e;if(t<=2){while(n.linePrev!==null)n=n.linePrev;return n}while(n!==null&&n.lineDepthAbs>t-2)n=n.linePrev;return n.lineNext},e.prototype._findPrevSibling=function(e){var t,n;t=e.lineDepthAbs,n=e.linePrev;if(n===null)return null;if(n.lineDepthAbs<t)return null;while(n.lineDepthAbs>t)n=n.linePrev;while(n.lineType[0]==="L")n=n.linePrev;return n},e.prototype._deleteMultiLinesSelections=function(e,t){var n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T;y=!0,e!==void 0?(y=!1,v=rangy.createRange(),e===null?(e=t,t=t.lineNext,this._putStartOnStart(v,e.line$[0].firstElementChild),t.line$.prepend("<span></span>"),this._putEndOnStart(v,t.line$[0].firstElementChild)):(S=e.line$[0].lastElementChild.previousElementSibling,o=t.line$[0].lastElementChild.previousElementSibling,v.setStartAfter(S,0),v.setEndAfter(o,0))):(this._findLines(),v=this.currentSel.range,b=v.startContainer,x=v.startOffset,e=this.currentSel.startLine,t=this.currentSel.endLine),s=t.lineDepthAbs,E=e.lineDepthAbs,n=s-E,g=rangy.createRangyRange(),g.setStart(v.endContainer,v.endOffset),g.setEndAfter(t.line$[0].lastChild),u=g.cloneContents(),t.lineType[1]==="h"&&e.lineType[1]!=="h"&&(t.lineType[0]==="L"&&(t.lineType="T"+t.lineType[1],t.line$.prop("class",""+t.lineType+"-"+t.lineDepthAbs)),this.markerList(t)),v.deleteContents(),e.line$[0].lastChild.nodeName==="BR"&&e.line$[0].removeChild(e.line$[0].lastChild),w=u.childNodes[0],c=e.line$[0].lastElementChild;if(w.tagName===(T=c.tagName)&&T==="SPAN"&&w.className===c.className){x=c.textContent.length,p=c.textContent+w.textContent,c.innerHTML=p,b=c.firstChild,f=1;while(f<u.childNodes.length)$(u.childNodes[f]).appendTo(e.line$),f++}else e.line$.append(u);e.lineNext=t.lineNext,t.lineNext!==null&&(t.lineNext.linePrev=e),t.line$.remove(),delete this._lines[t.lineID],l=e.lineNext;if(l!==null){r=l.lineDepthAbs-E;if(r>=1)while(l!==null&&l.lineDepthAbs>=s)h=l.lineDepthAbs-n,l.lineDepthAbs=h,l.line$.prop("class",""+l.lineType+"-"+h),l=l.lineNext}if(l!==null){l.lineType[0]==="L"&&(l.lineType="T"+l.lineType[1],l.line$.prop("class",""+l.lineType+"-"+l.lineDepthAbs)),a=l,i=l.lineDepthAbs,l=l.linePrev;while(l!==null&&l.lineDepthAbs>i)l=l.linePrev;l!==null&&(d=l.lineType,a.lineType!==d&&(d[1]==="h"?this._line2titleList(a):this.markerList(a)))}if(y)return m=rangy.createRange(),m.collapseToPoint(b,x),this.currentSel.sel.setSingleRange(m),this.currentSel=null},e.prototype._insertLineAfter=function(e){var t,n,r,i;return this._highestId+=1,t="CNID_"+this._highestId,e.fragment!=null?(r=$("<div id='"+t+"' class='"+e.targetLineType+"-"+e.targetLineDepthAbs+"'></div>"),r.append(e.fragment),(r[0].childNodes.length===0||r[0].lastChild.nodeName!=="BR")&&r.append("<br>")):e.innerHTML!=null?(r=$("<div id='"+t+"' class='"+e.targetLineType+"-"+e.targetLineDepthAbs+"'>                "+e.innerHTML+"</div>"),r[0].lastChild.nodeName!=="BR"&&r.append("<br>")):(r=$("<div id='"+t+"' class='"+e.targetLineType+"-"+e.targetLineDepthAbs+"'></div>"),r.append($("<span></span><br>"))),i=e.sourceLine,r=r.insertAfter(i.line$),n={line$:r,lineID:t,lineType:e.targetLineType,lineDepthAbs:e.targetLineDepthAbs,lineDepthRel:e.targetLineDepthRel,lineNext:i.lineNext,linePrev:i},this._lines[t]=n,i.lineNext!==null&&(i.lineNext.linePrev=n),i.lineNext=n,n},e.prototype._insertLineBefore=function(e){var t,n,r,i;return this._highestId+=1,t="CNID_"+this._highestId,r=$("<div id='"+t+"' class='"+e.targetLineType+"-"+e.targetLineDepthAbs+"'></div>"),e.fragment!=null?(r.append(e.fragment),r.append($("<br>"))):r.append($("<span></span><br>")),i=e.sourceLine,r=r.insertBefore(i.line$),n={line$:r,lineID:t,lineType:e.targetLineType,lineDepthAbs:e.targetLineDepthAbs,lineDepthRel:e.targetLineDepthRel,lineNext:i,linePrev:i.linePrev},this._lines[t]=n,i.linePrev!==null&&(i.linePrev.lineNext=n),i.linePrev=n,n},e.prototype._findLines=function(){var e,t,n,r,i,s,o,u;if(this.currentSel===null)return s=this.getEditorSelection(),i=s.getRangeAt(0),o=i.startContainer,e=i.endContainer,r=i.startOffset,n=i.endOffset,e.id!=null&&e.id.substr(0,5)==="CNID_"?t=this._lines[e.id]:t=this._lines[$(e).parents("div")[0].id],o.nodeName==="DIV"?u=this._lines[o.id]:u=this._lines[$(o).parents("div")[0].id],this.currentSel={sel:s,range:i,startLine:u,endLine:t,rangeIsStartLine:null,rangeIsEndLine:null}},e.prototype._findLinesAndIsStartIsEnd=function(){var e,t,n,r,i,s,o,u,a,f,l,c,h;if(this.currentSel===null){l=this.getEditorSelection(),u=l.getRangeAt(0),c=u.startContainer,e=u.endContainer,r=u.startOffset,n=u.endOffset;if(e.id!=null&&e.id.substr(0,5)==="CNID_")t=this._lines[e.id],a=e.children.length<n||e.children[n].nodeName==="BR";else{t=this._lines[$(e).parents("div")[0].id],a=!1,e.nodeType===Node.TEXT_NODE?a=e.nextSibling===null&&n===e.textContent.length:a=e.nodeName==="BR"||e.nextSibling.nodeName==="BR"&&e.childNodes.length===n,s=e.parentNode;while(a&&s.nodeName!=="DIV")i=s.nextSibling,a=i===null||i.nodeName==="BR",s=s.parentNode}if(c.nodeName==="DIV")h=this._lines[c.id],f=r===0;else{h=this._lines[$(c).parents("div")[0].id],c.nodeType===Node.TEXT_NODE?f=e.previousSibling===null&&r===0:f=r===0,o=c.parentNode;while(f&&o.nodeName!=="DIV")f=o.previousSibling===null,o=o.parentNode}return t.line$[0].innerHTML==="<span></span><br>"&&(a=!0),h.line$[0].innerHTML==="<span></span><br>"&&(f=!0),this.currentSel={sel:l,range:u,startLine:h,endLine:t,rangeIsStartLine:f,rangeIsEndLine:a}}},e.prototype._readHtml=function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g;d=this.editorBody$.children(),i=0,o=0,a=0,this._lines={},h=null,c=null;for(v=0,m=d.length;v<m;v++)t=d[v],n=$(t),r=(g=n.attr("class"))!=null?g:"",r=r.split("-"),p=r[0],p!==""&&(s=i,i=+r[1],e=i-s,u=o,p==="Th"?o=0:o=u+e,a=parseInt(a,10)+1,f="CNID_"+a,n.prop("id",f),l={line$:n,lineID:f,lineType:p,lineDepthAbs:i,lineDepthRel:o,lineNext:null,linePrev:h},h!==null&&(h.lineNext=l),h=l,this._lines[f]=l);return this._highestId=a},e.prototype._moveLinesDown=function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v;c=this.getEditorSelection(),l=c.getRangeAt(0),l.startContainer.nodeName==="BODY"?h=l.startContainer.children[l.startOffset]:h=l.startContainer,l.endContainer.nodeName==="BODY"?t=l.endContainer.children[l.endOffset-1]:t=l.endContainer,h.nodeName!=="DIV"&&(h=$(h).parents("div")[0]),p=h.id,t.nodeName!=="DIV"&&(t=$(t).parents("div")[0]),n=t.id,u=this._lines[p],i=this._lines[n],o=u.linePrev,s=i.lineNext;if(s!==null){e={line$:s.line$.clone(),lineID:s.lineID,lineType:s.lineType,lineDepthAbs:s.lineDepthAbs,lineDepthRel:s.lineDepthRel,linePrev:s.linePrev,lineNext:s.lineNext},this._deleteMultiLinesSelections(i,s),s=e,this._lines[s.lineID]=s,s.linePrev=o,u.linePrev=s,s.lineNext!==null&&(s.lineNext.linePrev=i),i.lineNext=s.lineNext,s.lineNext=u,o!==null&&(o.lineNext=s),u.line$.before(s.line$);if(o===null)return;if(s.lineDepthAbs<=o.lineDepthAbs){r=s;while(r.lineNext!==null&&r.lineNext.lineDepthAbs>s.lineDepthAbs)r=r.lineNext;r.lineNext!==null&&(r=r.lineNext),a=rangy.createRange(),a.setStart(u.line$[0],0),a.setEnd(r.line$[0],0),f=u.lineDepthAbs-s.lineDepthAbs,s.lineNext.lineType[0]==="T"&&(u.lineType[0]==="T"?f-=1:f+=1),d=[];while(f>=0)this.shiftTab(a),d.push(f-=1);return d}a=rangy.createRange(),a.setStart(s.line$[0],0),a.setEnd(s.line$[0],0),f=s.lineDepthAbs-o.lineDepthAbs,u.lineType[0]==="T"&&(o.lineType[0]==="T"?f-=1:f+=1),v=[];while(f>=0)this.shiftTab(a),v.push(f-=1);return v}},e.prototype._moveLinesUp=function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m;h=this.getEditorSelection(),c=h.getRangeAt(0),c.startContainer.nodeName==="BODY"?p=c.startContainer.children[c.startOffset]:p=c.startContainer,c.endContainer.nodeName==="BODY"?t=c.endContainer.children[c.endOffset-1]:t=c.endContainer,p.nodeName!=="DIV"&&(p=$(p).parents("div")[0]),d=p.id,t.nodeName!=="DIV"&&(t=$(t).parents("div")[0]),n=t.id,a=this._lines[d],s=this._lines[n],u=a.linePrev,o=s.lineNext;if(u!==null){r=u.linePrev===null,e={line$:u.line$.clone(),lineID:u.lineID,lineType:u.lineType,lineDepthAbs:u.lineDepthAbs,lineDepthRel:u.lineDepthRel,linePrev:u.linePrev,lineNext:u.lineNext},this._deleteMultiLinesSelections(u.linePrev,u),r&&($(u.line$[0].firstElementChild).remove(),u.line$.append("<br>"),a.line$=u.line$,a.line$.attr("id",a.lineID),this._lines[a.lineID]=a),u=e,this._lines[u.lineID]=u,u.lineNext=o,s.lineNext=u,u.linePrev!==null&&(u.linePrev.lineNext=a),a.linePrev=u.linePrev,u.linePrev=s,o!==null&&(o.linePrev=u),s.line$.after(u.line$);if(u.lineDepthAbs<=s.lineDepthAbs&&o!==null){i=u;while(i.lineNext!==null&&i.lineNext.lineDepthAbs>u.lineDepthAbs)i=i.lineNext;i.lineNext!==null&&(i=i.lineNext),f=rangy.createRange(),f.setStart(o.line$[0],0),f.setEnd(i.line$[0],0),l=o.lineDepthAbs-u.lineDepthAbs,u.lineNext.lineType[0]==="T"&&(u.lineType[0]==="T"?l-=1:l+=1),v=[];while(l>=0)this.shiftTab(f),v.push(l-=1);return v}f=rangy.createRange(),f.setStart(u.line$[0],0),f.setEnd(u.line$[0],0),l=u.lineDepthAbs-s.lineDepthAbs,u.lineType[0]==="T"&&(s.lineType[0]==="T"?l-=1:l+=1),m=[];while(l>=0)this.shiftTab(f),m.push(l-=1);return m}},e.prototype._addHistory=function(){var e,t;return t=this.saveEditorSelection(),this._history.historySelect.push(t),e={xcoord:this.editorBody$.scrollTop(),ycoord:this.editorBody$.scrollLeft()},this._history.historyScroll.push(e),this._history.historyPos.push(this.newPosition),this._history.history.push(this.editorBody$.html()),rangy.removeMarkers(t),this._history.index=this._history.history.length-1},e.prototype.undoPossible=function(){return this._history.index>0},e.prototype.redoPossible=function(){return this._history.index<this._history.history.length-2},e.prototype.unDo=function(){var e,t,n;if(this.undoPossible())return this._history.index===this._history.history.length-1&&(this._addHistory(),this._history.index-=1),this.newPosition=this._history.historyPos[this._history.index],this.editorBody$.html(this._history.history[this._history.index]),e=this._history.historySelect[this._history.index],e.restored=!1,rangy.restoreSelection(e),t=this._history.historyScroll[this._history.index].xcoord,n=this._history.historyScroll[this._history.index].ycoord,this.editorBody$.scrollTop(t),this.editorBody$.scrollLeft(n),this._readHtml(),this._history.index-=1},e.prototype.reDo=function(){var e,t,n;if(this.redoPossible())return this.newPosition=this._history.historyPos[this._history.index+1],this._history.index+=1,this.editorBody$.html(this._history.history[this._history.index+1]),e=this._history.historySelect[this._history.index+1],e.restored=!1,rangy.restoreSelection(e),t=this._history.historyScroll[this._history.index+1].xcoord,n=this._history.historyScroll[this._history.index+1].ycoord,this.editorBody$.scrollTop(t),this.editorBody$.scrollLeft(n),this._readHtml()},e.prototype._initSummary=function(){var e;return e=this.editorBody$.children("#navi"),e.length===0&&(e=$(document.createElement("div")),e.attr("id","navi"),e.prependTo(this.editorBody$)),e},e.prototype._buildSummary=function(){var e,t,n,r;n=this.initSummary(),this.editorBody$.children("#navi").children().remove(),t=this._lines,r=[];for(e in t)this.editorBody$.children("#"+(""+t[e].lineID)).length>0&&t[e].lineType==="Th"?r.push(t[e].line$.clone().appendTo(n)):r.push(void 0);return r},e.prototype.paste=function(e){var t,n,r;return t=this.clipboard,this._findLinesAndIsStartIsEnd(),n=rangy.createRange(),n.selectNodeContents(t),r=this.getEditorSelection(),r.setSingleRange(n),n.detach(),e&&e.clipboardData&&e.clipboardData.getData?(e.clipboardData.types==="text/html"?t.innerHTML=e.clipboardData.getData("text/html"):e.clipboardData.types==="text/plain"?t.innerHTML=e.clipboardData.getData("text/plain"):t.innerHTML="",this._waitForPasteData(t,this._processPaste),e.preventDefault&&(e.stopPropagation(),e.preventDefault()),!1):(t.innerHTML="",this._waitForPasteData(t,this._processPaste),!0)},e.prototype._initClipBoard=function(){var e,t,n;return t=$(document.createElement("div")),n={left:-300},t.offset(n),t.prependTo(this.editorBody$),e=t[0],e.style.setProperty("width","280px"),e.style.setProperty("position","fixed"),e.style.setProperty("overflow","hidden"),this.clipboard=e,e},e.prototype._waitForPasteData=function(e,t){var n;return(n=function(e){var r;return e.childNodes&&e.childNodes.length>0?t():(r={e:e},r.callself=function(){return n(r.e)},setTimeout(r.callself,10))})(e)},e.prototype._processPaste=function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A;x=this.clipboard,r=this.currentSel,E=x.innerHTML,E=sanitize(E).xss(),x.innerHTML=E,h=document.createDocumentFragment(),o={lineNext:null,linePrev:null,line$:$("<div id='dummy' class='Tu-1'></div>")},h.appendChild(o.line$[0]),i=document.createDocumentFragment(),e=r.startLine.lineDepthAbs,r.startLine.lineType==="Th"&&(e+=1),s={absDepth:e,prevHxLevel:null,frag:h,prevCNLineAbsDepth:null,lastAddedLine:o,currentLineFrag:i,currentLineEl:i,isCurrentLineBeingPopulated:!1},p=this._domWalk(x,s),x.innerHTML="",h.removeChild(h.firstChild),d=0;while(d<h.childNodes.length)v=h.childNodes[d],A=v.textContent,v.innerHTML="<span></span><br>",v.firstChild.appendChild(document.createTextNode(A)),d+=1;N=r.startLine,a=r.endLine,r.range.collapsed||(a===N?r.range.deleteContents():(this._deleteMultiLinesSelections(),r=this._findLinesAndIsStartIsEnd(),N=r.startLine)),k=r.range.startContainer,C=r.range.startOffset,k.length?f=k.length-C:f=k.childNodes.length-C,d=0,m=h.firstChild.childNodes,y=m.length;while(d<y-1)u=m[d],d+=1,u.tagName==="SPAN"&&(k.tagName==="SPAN"||k.nodeType===Node.TEXT_NODE)&&(L=k.textContent,b=L.substr(0,C),b+=u.textContent,b+=L.substr(C),k.textContent=b,C+=u.textContent.length);if(h.childNodes.length>1){S=document.createRange(),S.setStart(k,C),w=k;while(w.tagName!=="DIV")w=w.parentElement;S.setEnd(w,w.children.length-1),l=S.extractContents(),S.detach(),this._insertFrag(h.lastChild,h.lastChild.children.length-1,l),w=k;while(w.tagName!=="DIV")w=w.parentElement}return c=o.lineNext,T=c.lineNext,h.removeChild(h.firstChild),delete this._lines[c.lineID],T!==null&&(g=r.startLine.lineNext,r.startLine.lineNext=T,T.linePrev=r.startLine,g===null?this.editorBody$[0].appendChild(h):(s.lastAddedLine.lineNext=g,g.linePrev=s.lastAddedLine,this.editorBody$[0].insertBefore(h,g.line$[0]))),T!==null?(n=g.linePrev.line$[0].childNodes[0].firstChild,t=n.length-f,r.sel.collapse(n,t)):r.sel.collapse(k,C)},e.prototype._insertFrag=function(e,t,n){var r,i;if(t===0)return r=document.createRange(),r.setStart(startContainer,startOffset),r.setEnd(startContainer,startOffset),r.insertNode(n),r.detach();if(n.childNodes.length>0)return i=e.childNodes[t-1],i.textContent+=n.firstChild.textContent},e.prototype._domWalk=function(e,t){var n;this.__domWalk(e,t);if(t.currentLineFrag.childNodes.length>0)return n={sourceLine:t.lastAddedLine,fragment:t.currentLineFrag,targetLineType:"Tu",targetLineDepthAbs:t.absDepth,targetLineDepthRel:t.absDepth},t.lastAddedLine=this._insertLineAfter(n)},e.prototype.__domWalk=function(e,t){var n,r,i,s,o,u,a,f,l,c,h,p;n=t.absDepth,o=t.prevHxLevel,h=e.childNodes;for(l=0,c=h.length;l<c;l++){r=h[l];switch(r.nodeName){case"#text":f=document.createTextNode(r.textContent),(p=t.currentLineEl.nodeName)==="SPAN"||p==="A"?t.currentLineEl.appendChild(f):(a=document.createElement("span"),a.appendChild(f),t.currentLineEl.appendChild(a)),t.isCurrentLineBeingPopulated=!0;break;case"P":case"UL":case"OL":t.absDepth=n,this.__domWalk(r,t),t.isCurrentLineBeingPopulated&&this._appendCurrentLineFrag(t,n,n);break;case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":i=0,this.__domWalk(r,t),t.isCurrentLineBeingPopulated&&this._appendCurrentLineFrag(t,Math.min(0,i)+n,Math.min(0,i)+n);break;case"LI":t.isCurrentLineBeingPopulated&&this._appendCurrentLineFrag(t,n,n),this.__domWalk(r,t),t.isCurrentLineBeingPopulated&&this._appendCurrentLineFrag(t,n,n);break;case"BR":this._appendCurrentLineFrag(t,n,n);break;case"A":s=t.currentLineEl.lastChild,s!==null&&s.nodeName==="SPAN"?s.textContent+="[["+r.textContent+"|"+r.href+"]]":(u=document.createElement("span"),u.textContent=r.textContent+" [["+r.href+"]] ",t.currentLineEl.appendChild(u)),t.isCurrentLineBeingPopulated=!0;break;case"DIV":r.id.substr(0,5)==="CNID_"?this._clipBoard_Insert_InternalLine(r,t):this.__domWalk(r,t);break;default:s=t.currentLineEl.lastChild,s!==null&&s.nodeName==="SPAN"?s.textContent+=r.textContent:(u=document.createElement("span"),u.textContent=r.textContent,t.currentLineEl.appendChild(u)),t.isCurrentLineBeingPopulated=!0}}return!0},e.prototype._appendCurrentLineFrag=function(e,t,n){var r,i;return e.currentLineFrag.childNodes.length===0&&(i=document.createElement("span"),e.currentLineFrag.appendChild(i)),r={sourceLine:e.lastAddedLine,fragment:e.currentLineFrag,targetLineType:"Tu",targetLineDepthAbs:t,targetLineDepthRel:t},e.lastAddedLine=this._insertLineAfter(r),e.currentLineFrag=document.createDocumentFragment(),e.currentLineEl=e.currentLineFrag,e.isCurrentLineBeingPopulated=!1},e.prototype._clipBoard_Insert_InternalLine=function(e,t){var n,r,i,s;return r=e.className.split("-"),i=+r[1],r=r[0],t.prevCNLineAbsDepth||(t.prevCNLineAbsDepth=i),n=i-t.prevCNLineAbsDepth,n>0,s={sourceLine:t.lastAddedLine,innerHTML:e.innerHTML,targetLineType:"Tu",targetLineDepthAbs:t.absDepth,targetLineDepthRel:t.absDepth},t.lastAddedLine=this._insertLineAfter(s)},e.prototype._cozy2md=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d,v;s=$(document.createElement("div")).html(e),c="",i=0,r={A:function(e){var t,n;return n=e.attr("title")!=null?e.attr("title"):"",t=e.attr("href")!=null?e.attr("href"):"","["+e.html()+"]("+t+' "'+n+'")'},IMG:function(e){var t,n,r;return r=e.attr("title")!=null?e.attr("title"):"",t=e.attr("alt")!=null?e.attr("alt"):"",n=e.attr("src")!=null?e.attr("src"):"","!["+t+"]("+n+' "'+r+'")'},SPAN:function(e){return e.text()}},h={Th:function(e,t){var n,r;i=t,n="",r=0;while(r<t)n+="#",r++;return"\n"+n+" "},Lh:function(e,t){return"\n"},Tu:function(e,t){return"\n"+e+"+   "},Lu:function(e,t){return"\n"+e+"    "},To:function(e,t){return"\n"+e+"1.   "},Lo:function(e,t){return"\n"+e+"    "}},n=function(e){var t,n,r,s,o;s=e.split("-"),o=s[0],n=parseInt(s[1],10),t="",r=1;while(r<n-i)t+="    ",r++;return h[o](t,n)},t=s.children();for(o=d=0,v=t.length-1;0<=v?d<=v:d>=v;o=0<=v?++d:--d){f=$(t.get(o)),f.attr("class")!=null&&(c+=n(f.attr("class"))),a=f.children().length,u=0,p=" ";while(u<a)l=f.children().get(u),u+2===a&&(p=""),l.nodeType===1&&r[l.nodeName]!=null?c+=r[l.nodeName]($(l))+p:c+=$(l).text()+p,u++;c+="\n"}return c},e.prototype._md2cozy=function(e){var t,n,r,i,s,o,u,a;return t=new Showdown.converter,e=t.makeHtml(e),s=$(document.createElement("ul")).html(e),n="",o=0,r=function(e,t,n){var r;return o++,r="",n.contents().each(function(){var e;e=this.nodeName;if(e==="#text")return r+="<span>"+$(this).text()+"</span>";if(this.tagName!=null)return $(this).wrap("<div></div>"),r+=""+$(this).parent().html(),$(this).unwrap()}),"<div id=CNID_"+o+" class="+e+"-"+t+">"+r+"<br></div>"},i=0,u=function(e){var t;return t=e[0].tagName,t[0]==="H"?(i=parseInt(t[1],10),n+=r("Th",i,e)):t==="P"?n+=r("Lh",i,e):a(e,"u")},a=function(e,t){var s,o,u,f,l,c;u=e[0].tagName;if(u==="UL")return i++,e.children().each(function(){return a($(this),"u")}),i--;if(u==="OL")return i++,e.children().each(function(){return a($(this),"o")}),i--;if(u==="LI"&&e.contents().get(0)!=null){e.contents().get(0).nodeName==="#text"&&(e=e.clone().wrap("<p></p>").parent()),c=[];for(o=f=0,l=e.children().length-1;0<=l?f<=l:f>=l;o=0<=l?++f:--f)s=$(e.children().get(o)),o===0?c.push(n+=r("T"+t,i,s)):c.push(a(s,t));return c}if(u==="P")return n+=r("L"+t,i,e)},s.children().each(function(){return u($(this))}),n},e}()